<?php
require_once 'config/config.php';
requireLogin();

$pageTitle = 'Competency Management';
$pdo = getDBConnection();

$activeTab = $_GET['tab'] ?? 'gap-analysis';

// Get competency gaps
$gaps = $pdo->query("
    SELECT cg.*, u.full_name, u.department
    FROM competency_gaps cg
    JOIN users u ON cg.employee_id = u.id
    ORDER BY cg.gap_percentage DESC
")->fetchAll();

// Get skill assessments
$assessments = $pdo->query("
    SELECT sa.*, u.full_name, u.department
    FROM skill_assessments sa
    JOIN users u ON sa.employee_id = u.id
    ORDER BY sa.assessment_date DESC
")->fetchAll();

// Get competency matrix
$matrix = $pdo->query("
    SELECT cm.*, 
           GROUP_CONCAT(CONCAT(ec.level, ':', u.full_name, ':', ec.has_gap) SEPARATOR '|') as employees
    FROM competency_matrix cm
    LEFT JOIN employee_competencies ec ON cm.id = ec.competency_id
    LEFT JOIN users u ON ec.employee_id = u.id
    GROUP BY cm.id
")->fetchAll();

ob_start();
?>

<div class="p-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Competency Management</h1>
        <p class="text-gray-600">
            Analyze skill gaps, assess employee competencies, and track development
        </p>
    </div>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200">
        <div class="flex gap-4 overflow-x-auto">
            <a href="?tab=gap-analysis" class="pb-3 px-2 border-b-2 transition-colors whitespace-nowrap <?php echo $activeTab == 'gap-analysis' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-600 hover:text-gray-900'; ?>">
                <div class="flex items-center gap-2">
                    <i class="fas fa-bullseye"></i>
                    <span>Competency Gap Analysis</span>
                </div>
            </a>
            <a href="?tab=assessments" class="pb-3 px-2 border-b-2 transition-colors whitespace-nowrap <?php echo $activeTab == 'assessments' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-600 hover:text-gray-900'; ?>">
                <div class="flex items-center gap-2">
                    <i class="fas fa-chart-bar"></i>
                    <span>Skill Assessments</span>
                </div>
            </a>
            <a href="?tab=matrix" class="pb-3 px-2 border-b-2 transition-colors whitespace-nowrap <?php echo $activeTab == 'matrix' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-600 hover:text-gray-900'; ?>">
                <div class="flex items-center gap-2">
                    <i class="fas fa-award"></i>
                    <span>Competency Matrix</span>
                </div>
            </a>
        </div>
    </div>

    <!-- Gap Analysis Tab -->
    <?php if ($activeTab == 'gap-analysis'): ?>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-900">Employee Competency Gaps</h2>
            </div>

            <div class="space-y-4">
                <?php foreach ($gaps as $gap): ?>
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-1"><?php echo htmlspecialchars($gap['full_name']); ?></h3>
                                <p class="text-gray-600"><?php echo htmlspecialchars($gap['role']); ?></p>
                                <p class="text-gray-500 text-sm"><?php echo htmlspecialchars($gap['department']); ?></p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm <?php echo $gap['gap_percentage'] > 25 ? 'bg-red-100 text-red-700' : ($gap['gap_percentage'] > 15 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'); ?>">
                                <?php echo $gap['gap_percentage']; ?>% Gap
                            </span>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-600 text-sm mb-1">Required Competencies</p>
                                <p class="text-gray-900 font-semibold"><?php echo $gap['required_competencies']; ?></p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-600 text-sm mb-1">Current Competencies</p>
                                <p class="text-gray-900 font-semibold"><?php echo $gap['current_competencies']; ?></p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-gray-700">Competency Level</p>
                                <span class="text-gray-900"><?php echo $gap['current_competencies']; ?>/<?php echo $gap['required_competencies']; ?></span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-2">
                                <div
                                    class="bg-indigo-500 h-2 rounded-full competency-bar"
                                    style="width: 0%"
                                    data-target="<?php echo ($gap['current_competencies'] / $gap['required_competencies']) * 100; ?>"
                                ></div>
                            </div>
                        </div>

                        <?php if (!empty($gap['critical_gaps'])): ?>
                            <div>
                                <p class="text-gray-700 mb-2">Critical Skill Gaps:</p>
                                <div class="flex flex-wrap gap-2">
                                    <?php foreach (explode(', ', $gap['critical_gaps']) as $skill): ?>
                                        <span class="px-3 py-1 bg-red-50 text-red-700 rounded-full text-sm">
                                            <?php echo htmlspecialchars(trim($skill)); ?>
                                        </span>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        <?php endif; ?>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>
    <?php endif; ?>

    <!-- Skill Assessments Tab -->
    <?php if ($activeTab == 'assessments'): ?>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-900">Skill Assessment & Evaluation</h2>
                <button onclick="showScheduleAssessmentModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Schedule Assessment
                </button>
            </div>

            <div class="space-y-6">
                <?php foreach ($assessments as $assessment): ?>
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-1"><?php echo htmlspecialchars($assessment['full_name']); ?></h3>
                                <p class="text-gray-600"><?php echo htmlspecialchars($assessment['role']); ?></p>
                                <p class="text-gray-500 text-sm">
                                    Assessed on: <?php echo formatDate($assessment['assessment_date']); ?>
                                </p>
                            </div>
                            <div class="text-right">
                                <span class="px-3 py-1 rounded-full text-sm <?php echo getStatusBadge($assessment['status']); ?>">
                                    <?php echo htmlspecialchars($assessment['status']); ?>
                                </span>
                                <?php if ($assessment['status'] == 'Completed' && $assessment['overall_score']): ?>
                                    <p class="text-gray-900 mt-2 font-semibold">
                                        Overall Score: <?php echo $assessment['overall_score']; ?>%
                                    </p>
                                <?php endif; ?>
                            </div>
                        </div>

                        <?php if ($assessment['status'] == 'Completed'): ?>
                            <?php
                            $categories = $pdo->prepare("SELECT * FROM assessment_categories WHERE assessment_id = ?");
                            $categories->execute([$assessment['id']]);
                            $cats = $categories->fetchAll();
                            ?>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <?php foreach ($cats as $cat): ?>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <p class="text-gray-700"><?php echo htmlspecialchars($cat['category_name']); ?></p>
                                            <span class="px-2 py-1 rounded-full text-sm <?php echo getLevelBadge($cat['level']); ?>">
                                                <?php echo htmlspecialchars($cat['level']); ?>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                                <div
                                                    class="bg-indigo-500 h-2 rounded-full assessment-bar"
                                                    style="width: 0%"
                                                    data-target="<?php echo $cat['score']; ?>"
                                                ></div>
                                            </div>
                                            <span class="text-gray-900 text-sm assessment-score">0%</span>
                                        </div>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>
    <?php endif; ?>

    <!-- Competency Matrix Tab -->
    <?php if ($activeTab == 'matrix'): ?>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-2">Competency Matrix</h2>
                <p class="text-gray-600">
                    View and compare competency levels across employees
                </p>
            </div>

            <div class="space-y-6">
                <?php foreach ($matrix as $comp): ?>
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-1"><?php echo htmlspecialchars($comp['competency']); ?></h3>
                                <p class="text-gray-600 text-sm">
                                    Required Level: <span class="px-2 py-1 rounded <?php echo getLevelBadge($comp['required_level']); ?>">
                                        <?php echo htmlspecialchars($comp['required_level']); ?>
                                    </span>
                                </p>
                            </div>
                        </div>

                        <?php if (!empty($comp['employees'])): ?>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <?php
                                $employees = explode('|', $comp['employees']);
                                foreach ($employees as $empData):
                                    if (empty($empData)) continue;
                                    list($level, $name, $hasGap) = explode(':', $empData);
                                ?>
                                    <div class="p-4 rounded-lg border-2 <?php echo $hasGap == '1' ? 'border-orange-200 bg-orange-50' : 'border-green-200 bg-green-50'; ?>">
                                        <div class="flex items-center justify-between mb-2">
                                            <p class="text-gray-900 font-semibold"><?php echo htmlspecialchars($name); ?></p>
                                            <?php if ($hasGap == '1'): ?>
                                                <i class="fas fa-arrow-down text-orange-600"></i>
                                            <?php else: ?>
                                                <i class="fas fa-check-circle text-green-600"></i>
                                            <?php endif; ?>
                                        </div>
                                        <span class="px-2 py-1 rounded text-sm <?php echo getLevelBadge($level); ?>">
                                            <?php echo htmlspecialchars($level); ?>
                                        </span>
                                        <?php if ($hasGap == '1'): ?>
                                            <p class="text-orange-700 text-sm mt-2">Gap Identified</p>
                                        <?php endif; ?>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>
    <?php endif; ?>
</div>

<!-- Schedule Assessment Modal -->
<div id="scheduleAssessmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-900">Schedule Skill Assessment</h3>
            <button onclick="closeScheduleAssessmentModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="scheduleAssessmentForm" method="POST" action="" class="p-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Select Employee *</label>
                    <select name="employee_id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Choose Employee</option>
                        <?php 
                        $allEmployees = $pdo->query("SELECT id, full_name, department FROM users WHERE role != 'admin' ORDER BY full_name")->fetchAll();
                        foreach ($allEmployees as $emp): 
                        ?>
                            <option value="<?php echo $emp['id']; ?>"><?php echo htmlspecialchars($emp['full_name'] . ' - ' . $emp['department']); ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Assessment Date *</label>
                    <input type="date" name="assessment_date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Role</label>
                    <input type="text" name="role" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" onclick="closeScheduleAssessmentModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Schedule Assessment
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Animate progress bars on page load
document.addEventListener('DOMContentLoaded', function() {
    // Animate competency bars
    const competencyBars = document.querySelectorAll('.competency-bar');
    competencyBars.forEach(bar => {
        const target = parseFloat(bar.getAttribute('data-target')) || 0;
        animateProgressBar(bar, target);
    });

    // Animate assessment bars
    const assessmentBars = document.querySelectorAll('.assessment-bar');
    assessmentBars.forEach(bar => {
        const target = parseInt(bar.getAttribute('data-target')) || 0;
        const scoreSpan = bar.closest('.flex').querySelector('.assessment-score');
        animateProgressBar(bar, target, scoreSpan);
    });

    // Add hover effects to cards
    const cards = document.querySelectorAll('.border.border-gray-200.rounded-lg');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
            this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
});

// Animate Progress Bar
function animateProgressBar(element, target, percentageSpan) {
    if (!element) return;
    let current = 0;
    const increment = target / 50;
    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            element.style.width = target + '%';
            if (percentageSpan) percentageSpan.textContent = target + '%';
            clearInterval(timer);
        } else {
            element.style.width = current + '%';
            if (percentageSpan) percentageSpan.textContent = Math.floor(current) + '%';
        }
    }, 30);
}

// Schedule Assessment Modal
function showScheduleAssessmentModal() {
    const modal = document.getElementById('scheduleAssessmentModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeScheduleAssessmentModal() {
    const modal = document.getElementById('scheduleAssessmentModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('scheduleAssessmentForm').reset();
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('scheduleAssessmentModal');
    if (event.target === modal) {
        closeScheduleAssessmentModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeScheduleAssessmentModal();
    }
});
</script>

<?php
$content = ob_get_clean();
require_once 'includes/layout.php';
require_once 'includes/footer.php';
?>
